@model FUEN42Team3.Backend.Models.EfModels.Announcement

@{
    ViewData["Title"] = "公告編輯器";
    Layout = null;
}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Summernote -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.css" rel="stylesheet" />

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

    <style>
        .note-btn.dropdown-toggle::after {
            display: none !important;
        }

        .sticker-modal img {
            width: 80px;
            height: 80px;
            margin: 5px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s ease;
        }

            .sticker-modal img:hover {
                transform: scale(1.1);
                border: 2px solid #0d6efd;
            }
    </style>
</head>
<body>

    <form method="post" enctype="multipart/form-data" asp-controller="Forum" asp-action="CreateAnnouncement" onsubmit="return validateForm()">
        @Html.AntiForgeryToken()
    <div class="container mt-4">
        <h2 class="mb-3">公告編輯器</h2>
        <div class="mb-3 row g-2 align-items-center">
            <label for="title" class="col-auto col-form-label mb-0">標題：</label>
            <div class="col">
                <input type="text" class="form-control" id="title" name="Title" value="@Model?.Title" placeholder="請輸入標題5~50字" />
            </div>
        </div>

        <div class="mb-3 row g-2 align-items-center">
            <label for="StatusId" class="col-auto col-form-label mb-0">狀態：</label>
            <div class="col-auto">
                <select class="form-select" id="StatusId" name="StatusId" style="width: 120px;">
                <option value="1" selected="@(Model?.StatusId == 1)">公開</option>
                <option value="2" selected="@(Model?.StatusId == 2)">隱藏</option>
                <option value="3" selected="@(Model?.StatusId == 3)">草稿</option>
            </select>
            </div>
        </div>



<textarea id="editor" name="AnnouncementBody" class="form-control">@Model?.AnnouncementBody</textarea>
        <div class="mt-3">
            <button class="btn btn-primary me-2">送出</button>
        </div>
    </div>
    </form>

    <!-- 貼圖 Modal -->
    <div class="modal fade" id="stickerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content p-3 sticker-modal text-center">
                <h5>選擇貼圖</h5>
                <div id="stickerPageContainer"></div>
                <div class="mt-2">
                    <button id="prevStickerPage" class="btn btn-sm btn-outline-secondary me-2">上一頁</button>
                    <span id="stickerPageInfo"></span>
                    <button id="nextStickerPage" class="btn btn-sm btn-outline-secondary ms-2">下一頁</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知 Modal -->
    <div class="modal fade" id="infoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">通知</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
                </div>
                <div class="modal-body" id="infoModalMessage"></div>
            </div>
        </div>
    </div>

    <!-- jQuery & Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Summernote -->
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/lang/summernote-zh-TW.min.js"></script>

    <script>
        function validateForm() {
            const title = $('#title').val().trim();
            const content = $('#editor').summernote('code').replace(/<\/?[^>]+(>|$)/g, "").trim();

            if (title.length < 5 || title.length > 50) {
                showModal('標題字數需介於 5 ~ 50 字之間');
                return false;
            }

            if (content.length < 15 || content.length > 4000) {
                showModal('內容字數需介於 15 ~ 4000 字之間');
                return false;
            }

            // ✅ 同步 summernote 內容回 textarea
            $('#editor').val($('#editor').summernote('code'));

            return true;
        }

        function showModal(message) {
            $('#infoModalMessage').text(message);
            new bootstrap.Modal(document.getElementById('infoModal')).show();
        }

        $(function () {
            $('#editor').summernote({
                lang: 'zh-TW',
                placeholder: '請輸入內容 15~4000字',
                height: 400,
                disableDragAndDrop: true,
                toolbar: [
                    ['style', ['style']],
                    ['color', ['color']],
                    ['font', ['fontname', 'fontsize', 'fontsizeunit']],
                    ['insert', ['picture', 'link', 'video', 'hr']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['custom', ['sticker']],
                    ['misc', ['undo', 'redo']]
                ],
                buttons: {
                    sticker: function (context) {
                        const ui = $.summernote.ui;
                        return ui.button({
                            contents: '<i class="fa-regular fa-face-smile"></i> 貼圖',
                            tooltip: '插入貼圖',
                            click: () => {
                                $('#stickerModal').modal('show');
                                renderStickerPage();
                            }
                        }).render();
                    }
                }
            });

            const stickerList = Array.from({ length: 36 }, (_, i) => ({
                src: `/stickers/sticker_${i + 1}.png`,
                alt: `貼圖${i + 1}`
            }));
            const stickersPerPage = 8;
            let stickerPage = 1;

            function renderStickerPage() {
                const total = Math.ceil(stickerList.length / stickersPerPage);
                stickerPage = Math.max(1, Math.min(stickerPage, total));
                const pageStickers = stickerList.slice((stickerPage - 1) * stickersPerPage, stickerPage * stickersPerPage);

                $('#stickerPageContainer').empty().append(
                    pageStickers.map(sticker =>
                        $('<img>')
                            .attr({ src: sticker.src, alt: sticker.alt })
                            .on('click', () => {
                                $('#editor').summernote('insertImage', sticker.src, '貼圖');
                                $('#stickerModal').modal('hide');
                            })
                    )
                );
                $('#stickerPageInfo').text(`${stickerPage} / ${total}`);
                $('#prevStickerPage').prop('disabled', stickerPage === 1);
                $('#nextStickerPage').prop('disabled', stickerPage === total);
            }

            $('#prevStickerPage').click(() => { stickerPage--; renderStickerPage(); });
            $('#nextStickerPage').click(() => { stickerPage++; renderStickerPage(); });




            //
                    
            
        });
    </script>
    <script>
        // 如果有 TempData["Success"], 則自動關閉視窗並刷新主頁
        @if (TempData["Success"]?.ToString() == "true")
        {
            <text>
                    alert("公告儲存成功！");
                    if (window.opener) {
                        window.opener.location.reload();} // ⏪ 主頁刷新
                    
                    window.close(); // ⏹️ 關閉本視窗
            </text>
        }
    </script>

</body>
</html>
